import{r as d,j as e,D as $,i as C,l as S,C as N}from"./index-DojvWRwq.js";import{a as p}from"./axiosService-CIqL3udG.js";import{f as P}from"./index-BojVbZw0.js";import{N as R}from"./Navbar-nhVtWA00.js";import{a as U}from"./index-BLftQxS-.js";import"./axios-B6xwUs71.js";import"./index-VWaDGczM.js";import"./logout-B43L4CMw.js";import"./toaster-DnV5eZAN.js";import"./Set_Get-jfIHgayU.js";import"./logo-CI8ZzsgX.js";import"./iconBase-B-IRoAdN.js";const F=({conversation:a,lastMessage:x})=>{const[i,t]=d.useState(null);return d.useEffect(()=>{(async()=>{try{const u=a.members[0],h=await p.get(`${$}/user/${u}`);console.log(h.data.user,"Fetched user data:"),t(h.data.user)}catch(u){console.error("Error fetching doctor data:",u)}})()},[a,x]),console.log(i,"Current user data:"),e.jsx("div",{className:"bg-white rounded-lg shadow-md p-2 flex flex-col mb-1",children:e.jsxs("div",{className:"flex flex-col sm:flex-row items-center sm:items-start",children:[e.jsx("img",{className:"w-14 h-14 rounded-full object-cover mb-2 sm:mb-0 sm:mr-4",src:(i==null?void 0:i.profilePicture)||"defaultProfilePictureUrl",alt:"Doctor Profile"}),e.jsxs("div",{className:"flex flex-col text-center sm:text-left",children:[e.jsx("span",{className:"font-medium",children:(i==null?void 0:i.name)||"Unknown"}),e.jsx("span",{className:"text-gray-500 text-sm",children:(x==null?void 0:x.text)||"No messages yet"})]})]})})},O=({message:a,own:x,receiverProfilePicture:i,receiverName:t})=>e.jsxs("div",{className:`message flex flex-col mt-5 ml-5 ${x?"items-end":"items-start"}`,children:[e.jsx("div",{className:"fixed top-1 left-0  w-full lg:w-3/4 lg:ml-96 mt-16 h-13 bg-gray-200 flex items-center justify-between p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx("img",{src:i,alt:"Profile",className:"w-10 h-10 rounded-full mr-4"}),e.jsx("span",{className:"text-xl font-bold",children:t})]})}),e.jsx("div",{className:"flex mt-14",children:e.jsx("p",{className:`messageText p-2 rounded-lg ${x?"bg-blue-500 text-white":"bg-gray-300 text-black"}`,children:a==null?void 0:a.text})}),e.jsx("div",{className:"text-xs mt-1",children:a!=null&&a.createdAt?P(a.createdAt):""})]}),Y=()=>{const a=C(s=>s.DoctorSlice),[x,i]=d.useState([]),[t,y]=d.useState(null),[u,h]=d.useState([]),[M,A]=d.useState(""),[j,E]=d.useState(null),[w,I]=d.useState(null),c=S(),D=d.useRef(null);d.useEffect(()=>{c==null||c.on("getMessage",s=>{E({senderId:s.senderId,text:s.text,createdAt:Date.now()})}),c==null||c.on("updateLastMessage",s=>{i(l=>{const g=l.map(o=>o._id===s.conversationId?{...o,lastMessage:s.lastMessage}:o);return g.sort((o,n)=>{var m,r;return new Date((m=n.lastMessage)==null?void 0:m.createdAt).getTime()-new Date((r=o.lastMessage)==null?void 0:r.createdAt).getTime()}),g})})},[]),d.useEffect(()=>{j&&(t!=null&&t.members.includes(j.senderId)&&h(s=>[...s,j]),i(s=>{const l=s.map(g=>g._id===(t==null?void 0:t._id)?{...g,lastMessage:j}:g);return l.sort((g,o)=>{var n,m;return new Date((n=o.lastMessage)==null?void 0:n.createdAt).getTime()-new Date((m=g.lastMessage)==null?void 0:m.createdAt).getTime()}),l}))},[j,t]),d.useEffect(()=>{c==null||c.emit("addUser",a.id),c==null||c.on("getUsers",()=>{})},[a]),d.useEffect(()=>{(async()=>{try{const g=(await p.get(`${N}/conversations/${a.id}`)).data,o=await Promise.all(g.map(async n=>{const r=(await p.get(`${N}/messages/${n._id}`)).data.messages,f=r[r.length-1];return{...n,lastMessage:f}}));o.sort((n,m)=>{var r,f;return new Date((r=m.lastMessage)==null?void 0:r.createdAt).getTime()-new Date((f=n.lastMessage)==null?void 0:f.createdAt).getTime()}),i(o)}catch(l){console.error("Error fetching conversations:",l)}})()},[a.id]),d.useEffect(()=>{(async()=>{if(t)try{const l=await p.get(`${N}/messages/${t._id}`);h(l.data.messages)}catch(l){console.error("Error fetching messages:",l)}})()},[t]);const T=async s=>{y(s);const l=s.members.find(n=>n!==a.id);try{const n=await p.get(`${$}/user/${l}`);I(n.data.user)}catch(n){console.error("Error fetching receiver details:",n)}const o=(await p.get(`${N}/messages/${s._id}`)).data.messages.slice(-1)[0];i(n=>{const m=n.map(r=>r._id===s._id?{...r,lastMessage:o}:r);return m.sort((r,f)=>{var v,b;return new Date((v=f.lastMessage)==null?void 0:v.createdAt).getTime()-new Date((b=r.lastMessage)==null?void 0:b.createdAt).getTime()}),m})},_=async s=>{s.preventDefault();const l={senderId:a.id,text:M,conversationId:t==null?void 0:t._id},g=t.members.find(o=>o!==a.id);c==null||c.emit("sendMessage",{senderId:a.id,receiverId:g,text:M,conversationId:t==null?void 0:t._id});try{const o=await p.post(`${N}/messages`,l);h([...u,o.data]),A(""),i(n=>{const m=n.map(r=>r._id===(t==null?void 0:t._id)?{...r,lastMessage:o.data}:r);return m.sort((r,f)=>{var v,b;return new Date((v=f.lastMessage)==null?void 0:v.createdAt).getTime()-new Date((b=r.lastMessage)==null?void 0:b.createdAt).getTime()}),m})}catch(o){console.error("Error sending message:",o)}};return d.useEffect(()=>{var s;(s=D.current)==null||s.scrollIntoView({behavior:"smooth"})},[u]),e.jsxs(e.Fragment,{children:[e.jsx(R,{}),e.jsxs("div",{className:"h-[664px] flex flex-col lg:flex-row",children:[e.jsx("div",{className:"w-full lg:w-1/4 bg-gray-200",children:e.jsx("div",{className:"p-4 h-full flex flex-col",children:x.length>0?x.map((s,l)=>e.jsx("div",{onClick:()=>T(s),children:e.jsx(F,{conversation:s,lastMessage:s.lastMessage})},l)):e.jsx("div",{className:"flex justify-center items-center flex-grow",children:e.jsx("p",{className:"text-lg text-blue-900 font-bold mb-60",children:"Conversation list is empty!"})})})}),e.jsx("div",{className:"w-full lg:w-3/4 bg-gray-100",children:e.jsx("div",{className:"flex flex-col h-full",children:e.jsx("div",{className:"h-full flex flex-col overflow-y-scroll pr-4",children:t?e.jsxs(e.Fragment,{children:[u.map((s,l)=>e.jsx("div",{ref:D,children:e.jsx(O,{message:s,own:s.senderId===a.id,receiverProfilePicture:w==null?void 0:w.profilePicture,receiverName:w==null?void 0:w.name})},l)),e.jsxs("div",{className:"flex items-center mt-auto",children:[e.jsx("textarea",{className:"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none ml-4 mb-5",placeholder:"Write a message...",onChange:s=>A(s.target.value),value:M}),e.jsx("button",{className:"ml-2 px-3 py-2 bg-blue-500 text-white rounded-lg cursor-pointer focus:outline-none hover:bg-blue-600",onClick:_,children:e.jsx(U,{size:18})})]})]}):e.jsx("div",{className:"text-center text-xl text-gray-400 mt-20 lg:mt-52",children:"Open a chat to start conversation.."})})})})]})]})};export{Y as default};
